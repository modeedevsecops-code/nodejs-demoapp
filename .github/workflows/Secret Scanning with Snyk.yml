name: Secret Scanning with Snyk

on:
  push:
    branches:
      - main
      - 'feature/*'
  pull_request:
    branches:
      - main

jobs:
  snyk-secret-scan:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Set up Snyk CLI with the API token
      - name: Set up Snyk
        uses: snyk/actions/setup@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}  # Using the Snyk API Token stored in GitHub Secrets

      # Step 3: Run Snyk Secret Detection
      - name: Run Snyk secret scan
        run: snyk secret test  # This will scan the codebase for secrets like API keys and credentials

      # Optional: Fail the pipeline if secrets are found
      - name: Fail the build if secrets are found
        if: failure()  # Only runs if the secret scan fails (secrets detected)
        run: |
          echo "Secrets detected! Please review the scan results."
          exit 1

      # Optional: Upload the scan report for further analysis
      - name: Upload Snyk secret scan report
        uses: actions/upload-artifact@v2
        with:
          name: snyk-secret-scan-report
          path: snyk-secret-report.json  # If you generated a report with --json flag (not required for basic scanning)